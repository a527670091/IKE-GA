# Evo-Agent èšç±»è¿›åŒ–ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ä¸ºä»€ä¹ˆéœ€è¦èšç±»è¿›åŒ–](#ä¸ºä»€ä¹ˆéœ€è¦èšç±»è¿›åŒ–)
- [å®ç°åŸç†](#å®ç°åŸç†)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [å‚æ•°è¯´æ˜](#å‚æ•°è¯´æ˜)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [ç»“æœè§£é‡Š](#ç»“æœè§£é‡Š)

---

## æ¦‚è¿°

**èšç±»è¿›åŒ–**æ˜¯ Evo-Agent çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½ï¼Œå®ƒèƒ½å¤Ÿï¼š

1. **è‡ªåŠ¨è¯†åˆ«ä¸åŒç±»å‹çš„çŸ¥è¯†ç¼–è¾‘ä»»åŠ¡**ï¼ˆåŸºäº `relation_id`ï¼‰
2. **ä¸ºæ¯ç§ç±»å‹ç‹¬ç«‹å¯»æ‰¾æœ€ä¼˜ç¼–è¾‘ç­–ç•¥**
3. **å¤§å¹…é™ä½è®¡ç®—æˆæœ¬**ï¼ˆç›¸æ¯”å¯¹æ¯ä¸ªäº‹å®å•ç‹¬è¿›åŒ–ï¼‰

### æ ¸å¿ƒæ€æƒ³

> ä¸åŒç±»å‹çš„çŸ¥è¯†å…³ç³»ï¼ˆå¦‚"é›‡ä¸»å…³ç³»"vs"åœ°ç†å…³ç³»"ï¼‰éœ€è¦ä¸åŒçš„ç¼–è¾‘ç­–ç•¥ï¼Œ
> ä½†åŒä¸€ç±»å‹å†…çš„äº‹å®å¯ä»¥å…±äº«ç›¸åŒçš„æœ€ä¼˜ç­–ç•¥ã€‚

---

## ä¸ºä»€ä¹ˆéœ€è¦èšç±»è¿›åŒ–

### é—®é¢˜ï¼šå•äº‹å®è¿›åŒ–çš„å±€é™æ€§

åœ¨ Phase 1 çš„åŸºç¡€å®ç°ä¸­ï¼Œæˆ‘ä»¬åªé’ˆå¯¹**å•ä¸ªäº‹å®**ï¼ˆ`fact_idx=0`ï¼‰è¿›è¡Œè¿›åŒ–ï¼š

```python
fact_idx = 0  # åªä¼˜åŒ–ç¬¬ä¸€æ¡äº‹å®
fact_to_edit = facts_to_edit[fact_idx]
agents, history = evo_agent_main(args)
```

**å±€é™**ï¼š
- âŒ åªèƒ½éªŒè¯æ–¹æ³•åœ¨ä¸€æ¡äº‹å®ä¸Šçš„æ•ˆæœ
- âŒ æ— æ³•è¯„ä¼°åœ¨æ•´ä¸ªæ•°æ®é›†ä¸Šçš„å¹³å‡è¡¨ç°
- âŒ ä¸åŸå§‹ ICL baselineï¼ˆåœ¨ 2000 æ¡ä¸Šæµ‹è¯•ï¼‰ä¸å¯æ¯”

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | è®¡ç®—æˆæœ¬ | é€šç”¨æ€§ | å®ç°éš¾åº¦ |
|-----|---------|-------|---------|
| **ç‹¬ç«‹è¿›åŒ–** | 2000 Ã— è¿›åŒ– | ä½ï¼ˆper-factï¼‰ | ç®€å• |
| **å…¨å±€è”åˆ** | 1 Ã— è¿›åŒ– | é«˜ï¼ˆä½†å¯èƒ½å†²çªï¼‰ | ä¸­ç­‰ |
| **èšç±»è¿›åŒ–** â­ | K Ã— è¿›åŒ– (Kâ‰ˆ40) | ä¸­é«˜ï¼ˆå±€éƒ¨é€šç”¨ï¼‰ | ä¸­ç­‰ |

**èšç±»æ–¹æ¡ˆçš„ä¼˜åŠ¿**ï¼š
- âœ… æˆæœ¬ä»…ä¸ºç‹¬ç«‹è¿›åŒ–çš„ **1/50**
- âœ… ä¸ºæ¯ç§å…³ç³»ç±»å‹æ‰¾åˆ°ä¸“ç”¨ç­–ç•¥
- âœ… è‡ªç„¶æ”¯æŒ"è·¨äº‹å®æ³›åŒ–"è¯„ä¼°

---

## å®ç°åŸç†

### 1. èšç±»é˜¶æ®µ

åŸºäº CounterFact æ•°æ®é›†çš„ `relation_id` å­—æ®µè¿›è¡Œåˆ†ç»„ï¼š

```python
from evo_agent_ice.clustering import cluster_facts_by_relation

facts_to_edit, _ = load_data('counterfact.json')
clusters = cluster_facts_by_relation(facts_to_edit)

# ç¤ºä¾‹è¾“å‡º
# Cluster 0: P108 (é›‡ä¸»å…³ç³») - 156 facts
# Cluster 1: P17  (å›½å®¶å…³ç³») - 143 facts
# Cluster 2: P136 (æµæ´¾å…³ç³») - 121 facts
# ...
```

**å¸¸è§çš„ relation_id**ï¼š
- `P108`: employer (é›‡ä¸»)
- `P17`: country (å›½å®¶)
- `P19`: place of birth (å‡ºç”Ÿåœ°)
- `P27`: country of citizenship (å›½ç±)
- `P54`: member of sports team (è¿åŠ¨é˜Ÿ)
- `P136`: genre (æµæ´¾/ç±»å‹)
- `P495`: country of origin (èµ·æºå›½)

### 2. è¿›åŒ–é˜¶æ®µ

å¯¹æ¯ä¸ª cluster ç‹¬ç«‹è¿è¡Œè¿›åŒ–ï¼š

```python
for cluster in clusters:
    relation_id = cluster['relation_id']
    cluster_facts = cluster['facts']  # è¯¥ cluster çš„æ‰€æœ‰äº‹å®
    
    # åœ¨è¿™ä¸ª cluster çš„æ‰€æœ‰äº‹å®ä¸Šè”åˆè¯„ä¼°é€‚åº”åº¦
    fitness = average([
        calculate_fitness(strategy, fact1, model, tokenizer),
        calculate_fitness(strategy, fact2, model, tokenizer),
        ...
    ])
```

**å…³é”®ç‚¹**ï¼š
- ç§ç¾¤ä¸­çš„æ¯ä¸ª Agent åœ¨**è¯¥ cluster çš„æ‰€æœ‰äº‹å®ä¸Š**è¯„ä¼°
- é€‚åº”åº¦ = æ‰€æœ‰äº‹å®çš„å¹³å‡ (ES, PS, NS)
- è¿›åŒ–å‡ºçš„ç­–ç•¥å¯¹è¯¥ cluster å†…çš„æ‰€æœ‰äº‹å®éƒ½æœ‰æ•ˆ

### 3. ç»“æœæ±‡æ€»

æ¯ä¸ª cluster äº§ç”Ÿä¸€ä¸ªç‹¬ç«‹çš„ Pareto å‰æ²¿ï¼š

```
results_clustered/
â”œâ”€â”€ cluster_P108/
â”‚   â””â”€â”€ pareto_front.json  # é›‡ä¸»å…³ç³»çš„æœ€ä¼˜ç­–ç•¥
â”œâ”€â”€ cluster_P17/
â”‚   â””â”€â”€ pareto_front.json  # å›½å®¶å…³ç³»çš„æœ€ä¼˜ç­–ç•¥
â”œâ”€â”€ cluster_P136/
â”‚   â””â”€â”€ pareto_front.json  # æµæ´¾å…³ç³»çš„æœ€ä¼˜ç­–ç•¥
â””â”€â”€ summary.json           # æ‰€æœ‰ cluster çš„æ±‡æ€»
```

---

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```bash
python run_evo_agent_clustered.py \
    --population_size 6 \
    --num_generations 5 \
    --min_cluster_size 10 \
    --top_k_clusters 5
```

è¿™å°†ï¼š
1. èšç±»æ‰€æœ‰ 2000 æ¡äº‹å®
2. è¿‡æ»¤å‡º size â‰¥ 10 çš„ cluster
3. åªå¯¹å‰ 5 ä¸ªæœ€å¤§çš„ cluster è¿›åŒ–
4. æ¯ä¸ª cluster ç‹¬ç«‹è¿è¡Œ 6Ã—5 çš„è¿›åŒ–

### æŸ¥çœ‹èšç±»ç»Ÿè®¡

è¿è¡Œåé¦–å…ˆä¼šæ˜¾ç¤ºèšç±»ä¿¡æ¯ï¼š

```
======================================================================
èšç±»ç»Ÿè®¡
======================================================================
æ€» cluster æ•°: 42
æ€»äº‹å®æ•°: 2000

å‰ 10 ä¸ªæœ€å¤§çš„ cluster:
----------------------------------------------------------------------
Rank   Relation ID     Size       Percentage  
----------------------------------------------------------------------
1      P108            156        7.8%
2      P17             143        7.1%
3      P136            121        6.0%
4      P495            98         4.9%
5      P54             87         4.3%
...
```

---

## å‚æ•°è¯´æ˜

### èšç±»ç›¸å…³å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| `--min_cluster_size` | int | 5 | æœ€å° cluster å¤§å°ï¼Œå°äºæ­¤å€¼çš„å°†è¢«è·³è¿‡ |
| `--max_cluster_size` | int | None | æœ€å¤§ cluster å¤§å°é™åˆ¶ï¼ˆç”¨äºé™åˆ¶è®¡ç®—é‡ï¼‰ |
| `--top_k_clusters` | int | None | åªè¿›åŒ–å‰ K ä¸ªæœ€å¤§çš„ cluster |

### è¿›åŒ–å‚æ•°ï¼ˆä¸å•äº‹å®æ¨¡å¼ç›¸åŒï¼‰

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| `--population_size` | int | 6 | ç§ç¾¤å¤§å° |
| `--num_generations` | int | 5 | è¿›åŒ–ä»£æ•° |
| `--crossover_rate` | float | 0.8 | äº¤å‰æ¦‚ç‡ |
| `--mutation_rate` | float | 0.2 | å˜å¼‚æ¦‚ç‡ |
| `--k_demos` | int | 10 | æ¯ä¸ªç­–ç•¥çš„æ¼”ç¤ºæ•°é‡ |

### æ¨¡å‹å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| `--target_model_name` | str | 'EleutherAI/gpt-j-6B' | è¢«ç¼–è¾‘çš„ç›®æ ‡æ¨¡å‹ |
| `--evo_model_name` | str | 'gemini-2.0-flash-exp' | ç”¨äºè¿›åŒ–æ“ä½œçš„ LLM |

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå¿«é€ŸéªŒè¯ï¼ˆåªè¿›åŒ– 3 ä¸ªæœ€å¤§çš„ clusterï¼‰

```bash
python run_evo_agent_clustered.py \
    --top_k_clusters 3 \
    --population_size 4 \
    --num_generations 3 \
    --output_dir ./results_quick_test
```

**é¢„æœŸæ—¶é—´**ï¼šçº¦ 30-60 åˆ†é’Ÿï¼ˆå–å†³äº GPU å’Œ cluster å¤§å°ï¼‰

### ç¤ºä¾‹ 2ï¼šä¸­ç­‰è§„æ¨¡å®éªŒï¼ˆå‰ 10 ä¸ª clusterï¼‰

```bash
python run_evo_agent_clustered.py \
    --top_k_clusters 10 \
    --min_cluster_size 10 \
    --population_size 6 \
    --num_generations 5 \
    --gpu_devices "0,1" \
    --output_dir ./results_medium
```

**é¢„æœŸæ—¶é—´**ï¼š2-4 å°æ—¶

### ç¤ºä¾‹ 3ï¼šå®Œæ•´å®éªŒï¼ˆæ‰€æœ‰ clusterï¼‰

```bash
python run_evo_agent_clustered.py \
    --min_cluster_size 5 \
    --population_size 6 \
    --num_generations 5 \
    --gpu_devices "0,1,2,3" \
    --output_dir ./results_full
```

**é¢„æœŸæ—¶é—´**ï¼š8-12 å°æ—¶ï¼ˆå–å†³äºç¡¬ä»¶ï¼‰

### ç¤ºä¾‹ 4ï¼šåªé’ˆå¯¹ç‰¹å®šå¤§å°çš„ cluster

```bash
# åªè¿›åŒ–ä¸­ç­‰å¤§å°çš„ clusterï¼ˆ20-50 ä¸ªäº‹å®ï¼‰
python run_evo_agent_clustered.py \
    --min_cluster_size 20 \
    --max_cluster_size 50 \
    --output_dir ./results_medium_clusters
```

---

## ç»“æœè§£é‡Š

### è¾“å‡ºç›®å½•ç»“æ„

```
results_clustered_2024-11-18_12-30-00/
â”œâ”€â”€ cluster_info.json          # å®Œæ•´èšç±»ä¿¡æ¯
â”œâ”€â”€ selected_clusters.json     # è¢«é€‰ä¸­è¿›åŒ–çš„ clusters
â”œâ”€â”€ summary.json               # æ‰€æœ‰ç»“æœæ±‡æ€»
â”œâ”€â”€ cluster_P108/              # é›‡ä¸»å…³ç³» cluster
â”‚   â””â”€â”€ pareto_front.json
â”œâ”€â”€ cluster_P17/               # å›½å®¶å…³ç³» cluster
â”‚   â””â”€â”€ pareto_front.json
â””â”€â”€ ...
```

### summary.json æ ¼å¼

```json
{
  "timestamp": "2024-11-18_12-30-00",
  "num_clusters_evolved": 10,
  "total_time_seconds": 7234.56,
  "cluster_results": {
    "P108": {
      "num_facts": 156,
      "pareto_front_size": 4,
      "best_fitness": {
        "efficacy": 0.8750,
        "generalization": 0.7231,
        "specificity": 0.9123
      },
      "avg_pareto_fitness": {
        "efficacy": 0.8125,
        "generalization": 0.6842,
        "specificity": 0.8756
      }
    },
    ...
  }
}
```

### pareto_front.json æ ¼å¼

æ¯ä¸ª cluster çš„ `pareto_front.json` åŒ…å«ï¼š

```json
{
  "relation_id": "P108",
  "cluster_size": 156,
  "pareto_front_size": 4,
  "pareto_fitness": [
    [0.8750, 0.7231, 0.9123],
    [0.8125, 0.7892, 0.8456],
    ...
  ],
  "pareto_strategies": [
    ["demo1", "demo2", ..., "demo10"],
    ["demo1", "demo2", ..., "demo10"],
    ...
  ]
}
```

**è§£é‡Š**ï¼š
- `pareto_fitness`: å¸•ç´¯æ‰˜å‰æ²¿ä¸Šæ¯ä¸ª Agent çš„é€‚åº”åº¦ (ES, PS, NS)
- `pareto_strategies`: å¯¹åº”çš„æ¼”ç¤ºç­–ç•¥ï¼ˆå¯ç”¨äºåç»­æµ‹è¯•ï¼‰

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è°ƒæ•´ cluster è¿‡æ»¤å‚æ•°

**å¦‚æœè®¡ç®—èµ„æºæœ‰é™**ï¼š
```bash
--min_cluster_size 20 \
--top_k_clusters 5
```

**å¦‚æœæƒ³è¦å…¨é¢è¯„ä¼°**ï¼š
```bash
--min_cluster_size 3  # ä¿ç•™æ›´å¤šå° cluster
```

### 2. è°ƒæ•´è¿›åŒ–å‚æ•°

**å¿«é€ŸéªŒè¯**ï¼š
```bash
--population_size 4 \
--num_generations 3
```

**ç²¾ç»†ä¼˜åŒ–**ï¼š
```bash
--population_size 10 \
--num_generations 10
```

### 3. ä½¿ç”¨å¤š GPU

```bash
--gpu_devices "0,1,2,3"  # ä½¿ç”¨ 4 å¼  GPU å¹¶è¡Œè¯„ä¼°
```

æ¯ä¸ª GPU ä¼šè¢«åˆ†é…ä¸åŒçš„è¯„ä¼°ä»»åŠ¡ï¼ŒåŠ é€Ÿé€‚åº”åº¦è®¡ç®—ã€‚

---

## ä¸ Phase 1 çš„å…³ç³»

èšç±»è¿›åŒ–æ˜¯ Phase 1 çš„**æ‰©å±•**ï¼Œè€Œéæ›¿ä»£ï¼š

| æ¨¡å¼ | å…¥å£è„šæœ¬ | é€‚ç”¨åœºæ™¯ |
|-----|---------|---------|
| **å•äº‹å®æ¨¡å¼** | `run_evo_agent.py` | å¿«é€ŸéªŒè¯ã€è°ƒè¯• |
| **èšç±»æ¨¡å¼** | `run_evo_agent_clustered.py` | å®Œæ•´è¯„ä¼°ã€ä¸ baseline å¯¹æ¯” |

**ä¸¤è€…çš„å…±åŒç‚¹**ï¼š
- âœ… éƒ½ä½¿ç”¨ `Agent` æŠ½è±¡
- âœ… éƒ½ä½¿ç”¨ç›¸åŒçš„ NSGA-II ç®—æ³•
- âœ… éƒ½ä½¿ç”¨ LLM é©±åŠ¨çš„äº¤å‰å’Œå˜å¼‚

**åŒºåˆ«**ï¼š
- å•äº‹å®æ¨¡å¼ï¼šé€‚åº”åº¦åœ¨ 1 ä¸ªäº‹å®ä¸Šè®¡ç®—
- èšç±»æ¨¡å¼ï¼šé€‚åº”åº¦åœ¨ N ä¸ªäº‹å®ä¸Šå¹³å‡

---

## ä¸‹ä¸€æ­¥ï¼šPhase 2 é›†æˆ

å½“è¿›å…¥ Phase 2ï¼ˆå¼•å…¥ Collaborate å’Œ Self_Improveï¼‰æ—¶ï¼Œèšç±»è¿›åŒ–å°†è‡ªç„¶æ”¯æŒï¼š

```python
def agent_collaborate(parent_a: Agent, parent_b: Agent, cluster_context):
    """
    åœ¨åä½œ Prompt ä¸­å¯ä»¥åŠ å…¥ cluster çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
    """
    prompt = f"""
    ä½ ä»¬æ­£åœ¨ä¸º"{cluster_context['relation_id']}"ç±»å‹çš„çŸ¥è¯†ç¼–è¾‘åä½œã€‚
    è¿™ç±»å…³ç³»çš„ç‰¹ç‚¹æ˜¯...
    
    Agent A åœ¨ {cluster_context['num_facts']} ä¸ªäº‹å®ä¸Šçš„è¡¨ç°ï¼š...
    Agent B åœ¨ {cluster_context['num_facts']} ä¸ªäº‹å®ä¸Šçš„è¡¨ç°ï¼š...
    
    è¯·ç”Ÿæˆä¸€ä¸ªèåˆåä»£...
    """
```

è¿™æ · Agent èƒ½å¤Ÿæ„è¯†åˆ°è‡ªå·±åœ¨"ä¸ºå“ªç±»ä»»åŠ¡ä¼˜åŒ–"ï¼Œä»è€Œç”Ÿæˆæ›´æœ‰é’ˆå¯¹æ€§çš„ç­–ç•¥ã€‚

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦æŒ‰ relation_id èšç±»ï¼Ÿ

**A**: å› ä¸ºä¸åŒç±»å‹çš„çŸ¥è¯†å…³ç³»éœ€è¦ä¸åŒçš„ç¼–è¾‘ç­–ç•¥ã€‚ä¾‹å¦‚ï¼š
- "é›‡ä¸»å…³ç³»"ï¼ˆP108ï¼‰çš„ neighborhood prompts é€šå¸¸æ˜¯å…³äºå…¬å¸ã€èŒä½çš„
- "åœ°ç†å…³ç³»"ï¼ˆP17ï¼‰çš„ neighborhood prompts é€šå¸¸æ˜¯å…³äºåŸå¸‚ã€å›½å®¶çš„

å¼ºè¡Œç”¨åŒä¸€ä¸ªç­–ç•¥ç¼–è¾‘æ‰€æœ‰ç±»å‹ä¼šå¯¼è‡´å¹³å‡æ•ˆæœå·®ã€‚

### Q2: cluster å¤ªå°ä¼šæ€æ ·ï¼Ÿ

**A**: å¤ªå°çš„ clusterï¼ˆå¦‚åªæœ‰ 2-3 ä¸ªäº‹å®ï¼‰å¯èƒ½ï¼š
- è¿‡æ‹Ÿåˆè¿™å‡ ä¸ªäº‹å®
- è¿›åŒ–ä¸ç¨³å®š
- è®¡ç®—æµªè´¹

å»ºè®®è®¾ç½® `--min_cluster_size 5` æˆ–æ›´é«˜ã€‚

### Q3: å¦‚ä½•é€‰æ‹© top_k_clustersï¼Ÿ

**A**: å»ºè®®ç­–ç•¥ï¼š
- **éªŒè¯é˜¶æ®µ**ï¼š`--top_k_clusters 3`ï¼ˆåªæµ‹æœ€å¤§çš„å‡ ä¸ªï¼‰
- **è¯„ä¼°é˜¶æ®µ**ï¼š`--top_k_clusters 10`ï¼ˆè¦†ç›–ä¸»è¦ clusterï¼‰
- **å®Œæ•´å®éªŒ**ï¼šä¸è®¾ç½®ï¼ˆè¿›åŒ–æ‰€æœ‰ clusterï¼‰

### Q4: è®¡ç®—æ—¶é—´ä¼°ç®—ï¼Ÿ

**ç²—ç•¥ä¼°ç®—**ï¼ˆå• GPUï¼Œpopulation=6, generations=5ï¼‰ï¼š
- å•ä¸ª factï¼š~5 åˆ†é’Ÿ
- å•ä¸ª clusterï¼ˆ50 factsï¼‰ï¼š~15-30 åˆ†é’Ÿ
- 10 ä¸ª clustersï¼š~2-4 å°æ—¶

ä½¿ç”¨å¤š GPU å¯çº¿æ€§åŠ é€Ÿè¯„ä¼°éƒ¨åˆ†ã€‚

---

## æ€»ç»“

èšç±»è¿›åŒ–æ˜¯ Evo-Agent å®ç°**å¤§è§„æ¨¡è¯„ä¼°**çš„å…³é”®æŠ€æœ¯ï¼š

âœ… **æ•ˆç‡é«˜**ï¼šè®¡ç®—æˆæœ¬ä»…ä¸ºç‹¬ç«‹è¿›åŒ–çš„ 1/50  
âœ… **æ•ˆæœå¥½**ï¼šä¸ºä¸åŒç±»å‹çš„å…³ç³»æ‰¾åˆ°ä¸“ç”¨ç­–ç•¥  
âœ… **å¯æ‰©å±•**ï¼šè‡ªç„¶æ”¯æŒ Phase 2 çš„ Agent åä½œä¸è‡ªæˆ‘æ”¹è¿›  

ç«‹å³å°è¯•ï¼š

```bash
python run_evo_agent_clustered.py --top_k_clusters 3
```
